<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>My</title>
  <h3>ë‚˜ì˜ ì›¹(2391017, ì´ìœ¤ì§€)</h3>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    #main { max-width: 520px; border: 1px solid #ddd; border-radius: 12px; padding: 16px; height: 320px; overflow-y: auto; }
    .message-item { padding: 8px 10px; margin: 6px 0; border-radius: 10px; background: #f7f8fa; }
    .kv { font-size: 14px; color: #333; }
    .ts { font-size: 12px; color: #666; }
  </style>
  <script>
    const brokerUrl = 'wss://damoa.io:9002';
    const clientId  = 'iot-client-' + Math.random().toString(16).substr(2, 8);
    const options   = { clientId };

    console.log(`MQTT ë¸Œë¡œì»¤(${brokerUrl}) ì ‘ì† ì‹œë„...`);
    const client = mqtt.connect(brokerUrl, options);

    client.on('connect', () => {
      console.log(`âœ… ì ‘ì† ì„±ê³µ! (í´ë¼ì´ì–¸íŠ¸ ID: ${clientId})`);

      const topic = 'ewha/2391017';
      client.subscribe(topic, (err) => {
        if (!err) {
          console.log(`ğŸ“„ í† í”½ êµ¬ë… ì„±ê³µ: ${topic}`);
          client.publish('ewha/checkin', '2391017 ì´ìœ¤ì§€');
        } else {
          console.error('í† í”½ êµ¬ë… ì˜¤ë¥˜:', err);
        }
      });
    });

    client.on('message', (topic, message) => {
      const main = document.getElementById('main');
      const text = message.toString();
      let html  = '';

      // JSONì´ë©´ íŒŒì‹±í•´ì„œ ì˜ˆì˜ê²Œ, ì•„ë‹ˆë©´ ì›ë¬¸ ì¶œë ¥
      try {
        const obj = JSON.parse(text);
        const t = (obj.t ?? obj.temp ?? obj.temperature ?? obj["ì˜¨ë„"]);
        const h = (obj.h ?? obj.hum  ?? obj.humidity  ?? obj["ìŠµë„"]);
        const ts= obj.ts ? new Date(obj.ts*1000).toLocaleString() : new Date().toLocaleString();
        html = `
          <div class="message-item">
            <div class="kv">ğŸŒ¡ï¸ ì˜¨ë„: <b>${t}</b> Â°C &nbsp; â€¢ &nbsp; ğŸ’§ ìŠµë„: <b>${h}</b> %</div>
            <div class="ts">í† í”½: ${topic} â€¢ ì‹œê°: ${ts}</div>
          </div>`;
      } catch(e) {
        html = `
          <div class="message-item">
            <div class="kv">${text}</div>
            <div class="ts">í† í”½: ${topic} â€¢ ì‹œê°: ${new Date().toLocaleString()}</div>
          </div>`;
      }
      main.insertAdjacentHTML('beforeend', html);
      main.scrollTop = main.scrollHeight;
    });

    client.on('error', (err) => {
      console.error('ì—°ê²° ì˜¤ë¥˜:', err);
      client.end();
    });
  </script>
</head>
<body>
  <div id="main"></div>
</body>
</html>
