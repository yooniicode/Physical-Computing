<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>My</title>
  <h3>나의 웹(2391017, 이윤지)</h3>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    #main { max-width: 520px; border: 1px solid #ddd; border-radius: 12px; padding: 16px; height: 320px; overflow-y: auto; }
    .message-item { padding: 8px 10px; margin: 6px 0; border-radius: 10px; background: #f7f8fa; }
    .kv { font-size: 14px; color: #333; }
    .ts { font-size: 12px; color: #666; }
  </style>
  <script>
    const brokerUrl = 'wss://damoa.io:9002';
    const clientId  = 'iot-client-' + Math.random().toString(16).substr(2, 8);
    const options   = { clientId };

    console.log(`MQTT 브로커(${brokerUrl}) 접속 시도...`);
    const client = mqtt.connect(brokerUrl, options);

    client.on('connect', () => {
      console.log(`✅ 접속 성공! (클라이언트 ID: ${clientId})`);

      const topic = 'ewha/2391017';
      client.subscribe(topic, (err) => {
        if (!err) {
          console.log(`📄 토픽 구독 성공: ${topic}`);
          client.publish('ewha/checkin', '2391017 이윤지');
        } else {
          console.error('토픽 구독 오류:', err);
        }
      });
    });

    client.on('message', (topic, message) => {
      const main = document.getElementById('main');
      const text = message.toString();
      let html  = '';

      // JSON이면 파싱해서 예쁘게, 아니면 원문 출력
      try {
        const obj = JSON.parse(text);
        const t = (obj.t ?? obj.temp ?? obj.temperature ?? obj["온도"]);
        const h = (obj.h ?? obj.hum  ?? obj.humidity  ?? obj["습도"]);
        const ts= obj.ts ? new Date(obj.ts*1000).toLocaleString() : new Date().toLocaleString();
        html = `
          <div class="message-item">
            <div class="kv">🌡️ 온도: <b>${t}</b> °C &nbsp; • &nbsp; 💧 습도: <b>${h}</b> %</div>
            <div class="ts">토픽: ${topic} • 시각: ${ts}</div>
          </div>`;
      } catch(e) {
        html = `
          <div class="message-item">
            <div class="kv">${text}</div>
            <div class="ts">토픽: ${topic} • 시각: ${new Date().toLocaleString()}</div>
          </div>`;
      }
      main.insertAdjacentHTML('beforeend', html);
      main.scrollTop = main.scrollHeight;
    });

    client.on('error', (err) => {
      console.error('연결 오류:', err);
      client.end();
    });
  </script>
</head>
<body>
  <div id="main"></div>
</body>
</html>
